import 'package:posventa/domain/entities/product.dart';
import 'package:posventa/domain/entities/product_tax.dart';
import 'package:posventa/domain/entities/product_variant.dart';
import 'package:posventa/presentation/providers/providers.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'product_provider.g.dart';

@riverpod
class ProductSearchQuery extends _$ProductSearchQuery {
  @override
  String build() {
    return '';
  }

  void setQuery(String query) {
    state = query;
  }
}

@riverpod
class ProductList extends _$ProductList {
  @override
  Stream<List<Product>> build() {
    final query = ref.watch(productSearchQueryProvider);
    if (query.isEmpty) {
      final getAllProducts = ref.watch(getAllProductsProvider);
      return getAllProducts.stream();
    } else {
      return Stream.fromFuture(_searchProducts(query));
    }
  }

  Future<List<Product>> _searchProducts(String query) async {
    final searchProducts = ref.read(searchProductsProvider);
    return searchProducts(query);
  }

  void searchProducts(String query) {
    ref.read(productSearchQueryProvider.notifier).setQuery(query);
  }

  Future<void> addProduct(Product product) async {
    await ref.read(createProductProvider).call(product);
    // Stream will auto-update
  }

  Future<void> updateProduct(Product product) async {
    await ref.read(updateProductProvider).call(product);
    // Stream will auto-update
  }

  Future<void> deleteProduct(int id) async {
    await ref.read(deleteProductProvider).call(id);
    // Stream will auto-update
  }

  Future<void> toggleProductActive(int productId) async {
    final currentState = state.value;
    if (currentState == null) return;

    try {
      final product = currentState.firstWhere((p) => p.id == productId);
      final updatedProduct = product.copyWith(isActive: !product.isActive);
      await updateProduct(updatedProduct);
    } catch (e) {
      // Handle error or rethrow
      rethrow;
    }
  }
}

// Alias for backward compatibility if needed, though usage should be updated to productListProvider
// Note: productListProvider is generated by riverpod_generator from ProductList class
final productNotifierProvider = productListProvider;

extension ProductCopyWith on Product {
  Product copyWith({
    int? id,
    String? code,
    String? name,
    String? description,
    int? departmentId,
    int? categoryId,
    int? brandId,
    int? supplierId,
    int? unitId,
    bool? isSoldByWeight,
    bool? isActive,
    List<ProductTax>? productTaxes,
    List<ProductVariant>? variants,
  }) {
    return Product(
      id: id ?? this.id,
      code: code ?? this.code,
      name: name ?? this.name,
      description: description ?? this.description,
      departmentId: departmentId ?? this.departmentId,
      categoryId: categoryId ?? this.categoryId,
      brandId: brandId ?? this.brandId,
      supplierId: supplierId ?? this.supplierId,
      unitId: unitId ?? this.unitId,
      isSoldByWeight: isSoldByWeight ?? this.isSoldByWeight,
      isActive: isActive ?? this.isActive,
      productTaxes: productTaxes ?? this.productTaxes,
      variants: variants ?? this.variants,
    );
  }
}
